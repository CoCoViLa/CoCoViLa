package ee.ioc.cs.vsle.packageparse;

import ee.ioc.cs.vsle.vclass.*;
import ee.ioc.cs.vsle.graphics.*;

import ee.ioc.cs.vsle.util.db;
import ee.ioc.cs.vsle.synthesize.SpecParser;

import org.xml.sax.*;
import org.xml.sax.helpers.DefaultHandler;

import java.io.File;
import java.io.IOException;
import javax.xml.parsers.SAXParser;
import javax.xml.parsers.SAXParserFactory;
import javax.xml.parsers.ParserConfigurationException;
import java.awt.Font;
import java.awt.Color;
import java.util.ArrayList;


public class PackageParser {
	VPackage pack = new VPackage();

	PackageClass newClass;
	Port newPort;
	ClassField newField;
	ClassGraphics newGraphics;
	String element;
	String path;
	ArrayList classFields;
	boolean classIsRelation;
	final int CLASS = 1, PORT_OPEN = 2, PORT_CLOSED = 3, PACKAGE = 4, FIELD = 5, FIELD_KNOWN = 6;

	/**
	 * Statuses:
	 * 1 - class.
	 * 2 - ports and related information.
	 * 4 - package.
	 */
	int status;

	/**
	 * Class constructor.
	 * @param file File - package file.
	 */
	public PackageParser(File file) {

		// Use an instance of ourselves as the SAX event handler
		DefaultHandler handler = new PackageHandler();


		// Use the validating parser
		SAXParserFactory factory = SAXParserFactory.newInstance();

		factory.setValidating(true);
		path = file.getParent();

		try {
			// Parse the input
			SAXParser saxParser = factory.newSAXParser();

			saxParser.parse(file, handler);
		} catch (SAXException sxe) {
			// Error generated by this application (or a parser-initialization error)
			Exception x = sxe;

			if (sxe.getException() != null) {
				x = sxe.getException();
			}
			x.printStackTrace();
		} catch (ParserConfigurationException pce) {
			// Parser with specified options can't be built
			pce.printStackTrace();
		} catch (IOException ioe) {
			// I/O error
			ioe.printStackTrace();
		}
		db.p("doneparsing");
	} // PackageParser

	// ===========================================================
	// SAX DocumentHandler methods
	// ===========================================================
	class PackageHandler extends DefaultHandler {

		public InputSource resolveEntity(java.lang.String publicId, java.lang.String systemId) throws SAXException{
			InputSource is = null;
			System.out.println("--------------------");
			System.out.println("publicId=" + publicId);
			System.out.println("systemId=" + systemId);
			System.out.println("--------------------");
			// comment the next 2 lines, if you want to see the DTD specified in the XML file.
			if (systemId != null && systemId.endsWith("dtd"))
				is = new InputSource("package2.dtd");
			return is;
		}

		public void error(SAXParseException spe) {
			// Error generated by the parser

			db.p(
				"\n** Parsing error, line " + spe.getLineNumber() + ", uri "
				+ spe.getSystemId());
			//db.p("   " + spe.getMessage());

			// Use the contained exception, if any
			Exception x = spe;

			if (spe.getException() != null) {
				x = spe.getException();
			}
			x.printStackTrace();
		}

		public void setDocumentLocator(Locator l) {// Save this to resolve relative URIs or to give diagnostics.
		}

		public void startDocument() throws SAXException {
		}

		public void endDocument() throws SAXException {
		}

		public void startElement(String namespaceURI, String lName, String qName,
								 Attributes attrs) throws SAXException {
			element = qName;
			if (element.equals("package")) {
				status = PACKAGE;
			}
			if (element.equals("class")) {
				status = CLASS;
				String type = attrs.getValue("type");
				classIsRelation = false;
				if (type != null && type.equals("relation")) {
					classIsRelation = true;
				}
			}
			if (element.equals("graphics")) {
				newGraphics = new ClassGraphics();
				String showFields = attrs.getValue("showFields");
				String type = attrs.getValue("type");

				if (showFields != null && showFields.equals("true")) {
					newGraphics.showFields = true;
				}
				if (type != null && type.equals("relation")) {
					newGraphics.relation = true;
				}
			}

			if (element.equals("port")) {
				status = PORT_OPEN;
				String name = attrs.getValue("name");
				String type = attrs.getValue("type");
				String x = attrs.getValue("x");
				String y = attrs.getValue("y");
				String portConnection = attrs.getValue("portConnection");
				String strict = attrs.getValue("strict");

				newPort = new Port(name, type, Integer.parseInt(x),
					Integer.parseInt(y), portConnection, strict);
			}
			if (element.equals("open")) {
				status = PORT_OPEN;
			}
			if (element.equals("default")) {
				status = FIELD;
			}
			if (element.equals("known")) {
				status = FIELD_KNOWN;
			}


			if (element.equals("closed")) {
				status = PORT_CLOSED;
			}

			if (element.equals("fields")) {
				classFields = new ArrayList();
				;
			}
			if (element.equals("field")) {
				String name = attrs.getValue("name");
				String type = attrs.getValue("type");
				String value = attrs.getValue("value");

				newField = new ClassField(name, type, value);
				classFields.add(newField);

			}
			if (element.equals("text")) {
				String str = attrs.getValue("string");
				int colorInt = Integer.parseInt(attrs.getValue("colour"));
				int x = Integer.parseInt(attrs.getValue("x"));
				int y = Integer.parseInt(attrs.getValue("y"));
				String fontName = attrs.getValue("fontname");
				int fontStyle = Integer.parseInt(attrs.getValue("fontstyle"));
				int fontSize = Integer.parseInt(attrs.getValue("fontsize"));


				Font font = new Font(fontName, fontStyle, fontSize);

				Text newText = new Text(x, y, font, new Color(colorInt), 0.0,
					str);
				/*if (str.equals("*self"))
					newText.name = "self";
				else if (str.equals("*selfWithName"))
					newText.name = "selfName";*/
				newGraphics.addShape(newText);

			}

			if (element.equals("line")) {
				String x1 = attrs.getValue("x1");
				String x2 = attrs.getValue("x2");
				String y1 = attrs.getValue("y1");
				String y2 = attrs.getValue("y2");
				String color = attrs.getValue("colour");
				String stroke = attrs.getValue("stroke");
				String transp = attrs.getValue("transparency");
				double str = 1.0;
				if (stroke != null) {
					str = Double.parseDouble(stroke);
				}
				double tr = 1.0;
				if (transp != null) {
					tr = Double.parseDouble(transp);
				}

				Line newLine = new Line(Integer.parseInt(x1),
					Integer.parseInt(y1), Integer.parseInt(x2),
					Integer.parseInt(y2), Integer.parseInt(color), str, tr);

				newGraphics.addShape(newLine);
			}


			if (element.equals("rect")) {
				String x = attrs.getValue("x");
				String[] split = x.split("#");


				String y = attrs.getValue("y");
				String width = attrs.getValue("width");
				String height = attrs.getValue("height");
				String color = attrs.getValue("colour");
				String filled = attrs.getValue("filled");
				String stroke = attrs.getValue("stroke");
				String transp = attrs.getValue("transparency");
				double str = 1.0;
				if (stroke != null) {
					str = Double.parseDouble(stroke);
				}
				double tr = 1.0;
				if (transp != null) {
					tr = Double.parseDouble(transp);
				}

				Rect newRect = new Rect(Integer.parseInt(x), Integer.parseInt(y),
					Integer.parseInt(width), Integer.parseInt(height),
					Integer.parseInt(color),
					Boolean.valueOf(filled).booleanValue(),  str, tr);

				newGraphics.addShape(newRect);
			}
			if (element.equals("oval")) {
				String x = attrs.getValue("x");
				String y = attrs.getValue("y");
				String width = attrs.getValue("width");
				String height = attrs.getValue("height");
				String color = attrs.getValue("colour");
				String filled = attrs.getValue("filled");
				String stroke = attrs.getValue("stroke");
				String transp = attrs.getValue("transparency");
				double str = 1.0;
				if (stroke != null) {
					str = Double.parseDouble(stroke);
				}
				double tr = 1.0;
				if (transp != null) {
					tr = Double.parseDouble(transp);
				}

				Oval newOval = new Oval(Integer.parseInt(x), Integer.parseInt(y),
					Integer.parseInt(width), Integer.parseInt(height),
					Integer.parseInt(color),
					Boolean.valueOf(filled).booleanValue(),  str, tr);

				newGraphics.addShape(newOval);
			}
			if (element.equals("arc")) {
				String x = attrs.getValue("x");
				String y = attrs.getValue("y");
				String width = attrs.getValue("width");
				String height = attrs.getValue("height");
				String startAngle = attrs.getValue("startAngle");
				String arcAngle = attrs.getValue("arcAngle");
				String color = attrs.getValue("colour");
				String filled = attrs.getValue("filled");
				String stroke = attrs.getValue("stroke");
				String transp = attrs.getValue("transparency");
				double str = 1.0;
				if (stroke != null) {
					str = Double.parseDouble(stroke);
				}
				double tr = 1.0;
				if (transp != null) {
					tr = Double.parseDouble(transp);
				}

				Arc newArc = new Arc(Integer.parseInt(x), Integer.parseInt(y),
					Integer.parseInt(width), Integer.parseInt(height),
					Integer.parseInt(startAngle), Integer.parseInt(arcAngle),
					Integer.parseInt(color),
					Boolean.valueOf(filled).booleanValue(), 1.0, 0.0);

				newGraphics.addShape(newArc);
			}
			if (element.equals("bounds")) {
				String x = attrs.getValue("x");
				String y = attrs.getValue("y");
				String width = attrs.getValue("width");
				String height = attrs.getValue("height");

				newGraphics.setBounds(Integer.parseInt(x), Integer.parseInt(y),
					Integer.parseInt(width), Integer.parseInt(height));
			}

		}

		public void endElement(String namespaceURI, String sName, String qName) throws
			SAXException {
			if (qName.equals("class")) {
				pack.classes.add(newClass);
			}
			if (qName.equals("port")) {
				if (newPort.openGraphics == null) {
					newGraphics = new ClassGraphics();
					newGraphics.addShape(new Oval(-4, -4, 8, 8, 0, false, 1.0, 0.0));
					newGraphics.addShape(new Oval(-3, -3, 6, 6, 12632256, true, 1.0, 0.0));
					newGraphics.setBounds(-4, -4, 8, 8);
					newPort.openGraphics = newGraphics;
				}
				if (newPort.closedGraphics == null) {
					newGraphics = new ClassGraphics();
					newGraphics.addShape(new Oval(-4, -4, 8, 8, 0, true, 1.0, 0.0));
					newGraphics.setBounds(-4, -4, 8, 8);
					newPort.closedGraphics = newGraphics;
				}

				newClass.addPort(newPort);
				status = CLASS;
			}
			if (qName.equals("fields")) {
				newClass.fields = classFields;
				SpecParser sp = new SpecParser();
				ArrayList a = new ArrayList();
				try {
					a = sp.getFields(path + File.separator + newClass.name + ".java");
				} catch (IOException e) {
					db.p("Warning: class " + newClass.name + " specified in package does not exits.");
				}
				ClassField cf;
				for (int i = 0; i < classFields.size(); i++) {
					cf = ((ClassField) classFields.get(i));

					if (cf.type == null) {
						for (int j = 0; j < a.size(); j++) {
							if (((ClassField) a.get(j)).name == cf.name) {
								cf.type = ((ClassField) a.get(j)).type;
								cf.value = ((ClassField) a.get(j)).value;
							}
						}
					}
				}
				status = CLASS;
			}
			if (qName.equals("graphics")) {

				if (classIsRelation) {
					newGraphics.relation = true;
				}
				if (status == FIELD) {
					newField.defaultGraphics = newGraphics;
				} else if (status == FIELD_KNOWN) {
					newField.knownGraphics = newGraphics;
				} else if (status == PORT_OPEN) {
					newPort.openGraphics = newGraphics;
				} else if (status == PORT_CLOSED) {
					newPort.closedGraphics = newGraphics;
				} else {
					//newGraphics.packageClass = newClass;
					newClass.addGraphics(newGraphics);


				}
			}

		}

		public void characters(char buf[], int offset, int len) throws SAXException {
			String s = new String(buf, offset, len);

			if (element.equals("name")) {
				// if we are reading a package field
				if (status == PACKAGE) {
					pack.name = s;
				} else { // else we a reading a class field
					newClass = new PackageClass(s);
					// classNames.add(s);
				}
			}
			if (element.equals("description") && status == PACKAGE) {
				pack.description = s;
			}

			if (element.equals("description") && status != PACKAGE) {
				newClass.description = s;
			}
			if (element.equals("icon")) {
				newClass.icon = s;
			}

			/* if (element.equals("portname")) {
			 newPort = new ee.ioc.cs.editor.vclass.Port(s);
			 }
			 if (element.equals("type")) {
			 newPort.type = s;
			 }
			 if (element.equals("dataType")) {
			 newPort.dataType = s;
			 }
			 if (element.equals("xpos")) {
			 newPort.xPos = Integer.parseInt(s);
			 }
			 if (element.equals("ypos")) {
			 newPort.yPos = Integer.parseInt(s);
			 }*/

		}

		public void ignorableWhitespace(char buf[], int offset, int len) throws SAXException {// Purposely ignore it.
		}

		public void processingInstruction(String target, String data) throws SAXException {// Purposely ignore it.
		}

	}

	/**
	 * Treat validation errors as fatal.
	 * SAX ErrorHandler method.
	 * @param e - SAXParseException.
	 * @throws SAXParseException -
	 */
	public void error(SAXParseException e) throws SAXParseException {
		db.p(e);
	} // error

	/**
	 * Output warnings via the debug output module.
	 * SAX ErrorHandler method.
	 * @param e - SAXParseException.
	 * @throws SAXParseException -
	 */
	public void warning(SAXParseException e) throws SAXParseException {
		db.p(
			"** Warning, line " + e.getLineNumber() + ", uri "
			+ e.getSystemId());
		db.p("   " + e.getMessage());
	} // warning

	/**
	 * Parse the Java file, read the specification and make the relations accordingly.
	 * @return VPackage -
	 */
	public VPackage getPackage() {
		return pack;
	} // getPackage

}

